# å¯¼å…¥æˆ‘ä»¬éœ€è¦çš„åº“
import time
import multiprocessing as mp
from mnemonic import Mnemonic
from bip_utils import (
    Bip39SeedGenerator, Bip44, Bip44Coins, Bip44Changes
)

# --- æ‚¨éœ€è¦åœ¨è¿™é‡Œè®¾ç½®ä¸¤ç§å¸çš„é“å·è§„åˆ™ ---
# è§„åˆ™è¶Šç®€å•ï¼Œæ‰¾åˆ°çš„å¯èƒ½æ€§æ‰è¶Šå¤§ï¼å»ºè®®2-3ä½ã€‚
ETH_PREFIX_TO_FIND = "888888"  # ä»¥å¤ªåŠåœ°å€ä»¥ 0x... å¼€å¤´
TRON_PREFIX_TO_FIND = "Styx8888" # æ³¢åœºåœ°å€ä»¥ T... å¼€å¤´
# ------------------------------------

# --- å¤šè¿›ç¨‹é…ç½® ---
# è®¾ç½®è¦ä½¿ç”¨çš„CPUæ ¸å¿ƒæ•°ã€‚mp.cpu_count() ä¼šè·å–æ‚¨ç”µè„‘çš„æ‰€æœ‰æ ¸å¿ƒæ•°ã€‚
# å¦‚æœæ‚¨æƒ³ä¿ç•™ä¸€äº›CPUç»™å…¶ä»–ä»»åŠ¡ï¼Œå¯ä»¥å†™æˆ mp.cpu_count() - 1
NUM_PROCESSES = mp.cpu_count()
# ------------------

def worker(result_queue, stop_event, process_id, eth_prefix, tron_prefix):
    """
    æ¯ä¸ªâ€œå·¥äººâ€è¿›ç¨‹æ‰§è¡Œçš„å‡½æ•°
    """
    # æ¯ä¸ªè¿›ç¨‹éƒ½æ‹¥æœ‰è‡ªå·±çš„åŠ©è®°è¯ç”Ÿæˆå™¨
    mnemo = Mnemonic("english")
    count = 0
    start_time = time.time()

    print(f"è¿›ç¨‹ #{process_id} å·²å¯åŠ¨ï¼Œå¼€å§‹è®¡ç®—...")

    while not stop_event.is_set():
        # 1. ç”ŸæˆåŠ©è®°è¯å’Œç§å­
        words = mnemo.generate(strength=128)
        seed_bytes = Bip39SeedGenerator(words).Generate()

        # 2. æ´¾ç”Ÿä»¥å¤ªåŠé’±åŒ…å¹¶æ£€æŸ¥
        bip44_eth_mst = Bip44.FromSeed(seed_bytes, Bip44Coins.ETHEREUM)
        bip44_eth_acc = bip44_eth_mst.Purpose().Coin().Account(0).Change(Bip44Changes.CHAIN_EXT).AddressIndex(0)
        eth_address = bip44_eth_acc.PublicKey().ToAddress()

        # 3. æ´¾ç”Ÿæ³¢åœºé’±åŒ…å¹¶æ£€æŸ¥
        bip44_tron_mst = Bip44.FromSeed(seed_bytes, Bip44Coins.TRON)
        bip44_tron_acc = bip44_tron_mst.Purpose().Coin().Account(0).Change(Bip44Changes.CHAIN_EXT).AddressIndex(0)
        tron_address = bip44_tron_acc.PublicKey().ToAddress()

        # 4. æ ¸å¿ƒæ£€æŸ¥
        if eth_address.lower().startswith(eth_prefix) and tron_address.startswith(tron_prefix):
            # æ‰¾åˆ°äº†ï¼è®¾ç½®åœæ­¢äº‹ä»¶å¹¶æŠŠç»“æœæ”¾å…¥é˜Ÿåˆ—
            stop_event.set()
            
            eth_private_key = bip44_eth_acc.PrivateKey().Raw().ToHex()
            tron_private_key = bip44_tron_acc.PrivateKey().Raw().ToHex()
            
            result_queue.put({
                "words": words,
                "eth_address": eth_address,
                "eth_pk": f"0x{eth_private_key}",
                "tron_address": tron_address,
                "tron_pk": tron_private_key,
                "found_by": process_id
            })
            break # æ‰¾åˆ°åå·¥äººé€€å‡ºå¾ªç¯

        count += 1
        # æ¯ä¸ªå·¥äººå¯ä»¥ç‹¬ç«‹æŠ¥å‘Šè‡ªå·±çš„è¿›åº¦ï¼Œä½†ä¸ºäº†ç•Œé¢å¹²å‡€ï¼Œå¯ä»¥æ³¨é‡Šæ‰
        # if count % 10000 == 0:
        #     elapsed = time.time() - start_time
        #     hps = count / elapsed if elapsed > 0 else 0
        #     print(f"\rè¿›ç¨‹ #{process_id} å·²å°è¯• {count} æ¬¡, é€Ÿåº¦: {hps:.0f} H/s", end="")


if __name__ == '__main__':
    # å‡†å¤‡å¥½è¦åŒ¹é…çš„å®Œæ•´å‰ç¼€
    eth_vanity_prefix = "0x" + ETH_PREFIX_TO_FIND.lower()
    tron_vanity_prefix = TRON_PREFIX_TO_FIND

    print("="*60)
    print("å¤šè¿›ç¨‹é“å·åœ°å€ç”Ÿæˆå™¨å·²å¯åŠ¨ï¼")
    print(f"ç›®æ ‡CPUæ ¸å¿ƒæ•°: {NUM_PROCESSES}")
    print(f"ETH è§„åˆ™: åœ°å€ä»¥ '{eth_vanity_prefix}' å¼€å¤´")
    print(f"TRON è§„åˆ™: åœ°å€ä»¥ '{tron_vanity_prefix}' å¼€å¤´")
    print("æ‰¾åˆ°åä¼šè‡ªåŠ¨åœæ­¢ã€‚è¿™ä¼šéå¸¸éå¸¸æ…¢ï¼Œè¯·æœ‰æå¤§çš„è€å¿ƒ...")
    print("="*60)

    # åˆ›å»ºç”¨äºé€šä¿¡çš„é˜Ÿåˆ—å’Œäº‹ä»¶
    result_queue = mp.Queue()
    stop_event = mp.Event()
    
    # åˆ›å»ºå¹¶å¯åŠ¨æ‰€æœ‰å·¥äººè¿›ç¨‹
    processes = []
    for i in range(NUM_PROCESSES):
        p = mp.Process(target=worker, args=(result_queue, stop_event, i + 1, eth_vanity_prefix, tron_vanity_prefix))
        processes.append(p)
        p.start()

    # ä¸»è¿›ç¨‹ç­‰å¾…ç»“æœ
    start_time = time.time()
    try:
        result = result_queue.get() # è¿™ä¼šé˜»å¡ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸­æœ‰ä¸œè¥¿
        
        # æ‰¾åˆ°äº†ï¼
        end_time = time.time()
        
        print("\n\nğŸ‰ğŸ‰ğŸ‰ è¶…çº§å¹¸è¿æ˜Ÿï¼æ‰¾åˆ°äº†åŒæ—¶æ»¡è¶³ä¸¤ä¸ªå¸ç§çš„é“å·åŠ©è®°è¯ï¼ğŸ‰ğŸ‰ğŸ‰")
        print(f"(ç”±è¿›ç¨‹ #{result['found_by']} æ‰¾åˆ°)")
        print("-" * 60)
        print(f"ğŸ”‘ åŠ©è®°è¯ (Mnemonic): {result['words']}")
        print("-" * 60)
        print(f"ğŸ’¼ ä»¥å¤ªåŠ (EVM) é“å·åœ°å€: {result['eth_address']}")
        print(f"ğŸ” ä»¥å¤ªåŠ (EVM) ç§é’¥: {result['eth_pk']}")
        print("-" * 60)
        print(f"ğŸ’¼ æ³¢åœº (TRON) é“å·åœ°å€: {result['tron_address']}")
        print(f"ğŸ” æ³¢åœº (TRON) ç§é’¥: {result['tron_pk']}")
        print("-" * 60)
        print(f"æ€»è€—æ—¶ {end_time - start_time:.2f} ç§’ã€‚")

    except KeyboardInterrupt:
        print("\nç”¨æˆ·æ‰‹åŠ¨ä¸­æ–­ç¨‹åºã€‚")
    finally:
        # ç¡®ä¿æ‰€æœ‰è¿›ç¨‹éƒ½è¢«ç»ˆæ­¢
        print("æ­£åœ¨åœæ­¢æ‰€æœ‰å·¥äººè¿›ç¨‹...")
        stop_event.set() # é€šçŸ¥æ‰€æœ‰è¿›ç¨‹åœæ­¢
        for p in processes:
            p.join(timeout=1) # ç­‰å¾…è¿›ç¨‹ç»“æŸ
            if p.is_alive():
                p.terminate() # å¦‚æœè¿˜æ²¡ç»“æŸï¼Œå¼ºåˆ¶ç»ˆæ­¢
        print("æ‰€æœ‰è¿›ç¨‹å·²åœæ­¢ã€‚")